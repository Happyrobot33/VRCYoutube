name: "Release"
on:
  workflow_dispatch:
  
  push:
    tags:
      - 'v*.*.*'

jobs:
  sign:
    name: "Release"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v1
      
      - name: "Get Version"
        id: get_version
        #read the version from src/manifest.json using fromJSON
        #print the version to the console
        run: |
          echo ::set-output name=version::$(jq -r .version src/manifest.json)
          echo "Version: $(jq -r .version src/manifest.json)"

      - name: "Increment manifest ver number"
        # Increment manifest version number in src/manifest.json.
        # Increment the two digits after the last dot.
        uses: jossef/action-set-json-field@v2
        with:
          file: src/manifest.json
          field: version
          # Increment the two digits after the last dot by 0.01
          #get the version from the previous step, then increment it by 0.01
          #dont use awk
          value: ${{ steps.get_version.outputs.VERSION }} + 0.01 | tonumber | tostring

      - name: "Show incremented manifest ver number"
        # Print the incremented manifest version number to the console.
        run: |
          echo "Version: $(jq -r .version src/manifest.json)"

      - name: "Commit changes"
        # Commit the changes to the manifest.json file
        uses: EndBug/add-and-commit@v4
        with:
          author_name: "GitHub Actions"

      - name: "web-ext build"
        id: web-ext-build
        uses: kewisch/action-web-ext@v1
        with:
          cmd: build
          source: src

      - name: "web-ext sign"
        id: web-ext-sign
        uses: kewisch/action-web-ext@v1
        with:
          cmd: sign
          source: ${{ steps.web-ext-build.outputs.target }}
          channel: unlisted
          apiKey: ${{ secrets.AMO_SIGN_KEY }}
          apiSecret: ${{ secrets.AMO_SIGN_SECRET }}
          timeout: 900000
      
      - name: "Generate release tag"
        id: tag
        run: echo "::set-output name=release_tag::FirefoxBuild_$(date +"%Y.%m.%d_%H-%M")"

      - name: "Create Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: ${{ steps.web-ext-sign.outputs.target }}
